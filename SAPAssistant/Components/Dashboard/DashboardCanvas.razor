@using SAPAssistant.Models
@inject IJSRuntime JS

<div class="dashboard-canvas">
    @foreach (var widget in Widgets)
    {
        <div class="widget-draggable"
             data-id="@widget.Id"
             data-x="@widget.X"
             data-y="@widget.Y"
             style="transform: translate(@widget.Xpx, @widget.Ypx)">
            <div class="widget-card">
                <div class="widget-header">
                    <strong>@widget.Title</strong>
                    <span class="widget-actions">
                        <button @onclick="() => EditarWidget(widget)">✏️</button>
                        <button @onclick="() => OnRemoveWidget.InvokeAsync(widget)">🗑️</button>
                    </span>
                </div>
                <div class="widget-body">
                    @RenderWidgetBody(widget)
                </div>
            </div>
        </div>
    }
</div>

@if (MostrarEditor && WidgetEnEdicion is not null)
{
    <SAPAssistant.Components.Chart.ChartWidgetEditor Widget="WidgetEnEdicion"
                       OnClose="CerrarEditor"
                       OnSave="GuardarWidgetEditado" />
}

@code {
    [Parameter] public List<DashboardWidgetModel> Widgets { get; set; } = new();
    [Parameter] public EventCallback<DashboardWidgetModel> OnEditWidget { get; set; }
    [Parameter] public EventCallback<DashboardWidgetModel> OnRemoveWidget { get; set; }

    private static DashboardCanvas? _instance;

    private bool MostrarEditor { get; set; } = false;
    private DashboardWidgetModel WidgetEnEdicion { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _instance = this;
            await JS.InvokeVoidAsync("initializeDraggableWidgets");
        }
    }

    [JSInvokable]
    public static Task UpdateWidgetPosition(string id, double x, double y)
    {
        var widget = _instance?.Widgets.FirstOrDefault(w => w.Id == id);
        if (widget is not null)
        {
            widget.X = x;
            widget.Y = y;
        }
        return Task.CompletedTask;
    }

    private RenderFragment RenderWidgetBody(DashboardWidgetModel widget) => builder =>
    {
        switch (widget.Type.ToLower())
        {
            case "kpi":
                builder.AddContent(0, $"🔢 Valor KPI: 123");
                break;

            case "chart":
                builder.OpenComponent<ChartWidget>(1);
                builder.AddAttribute(2, "Widget", widget);
                builder.CloseComponent();
                break;

            case "table":
                builder.AddMarkupContent(3, @"
                    <table class='widget-table'>
                        <thead><tr><th>Col 1</th><th>Col 2</th></tr></thead>
                        <tbody>
                            <tr><td>A</td><td>100</td></tr>
                            <tr><td>B</td><td>200</td></tr>
                        </tbody>
                    </table>");
                break;

            default:
                builder.AddContent(4, $"🧩 Widget: {widget.Type}");
                break;
        }
    };

    private void EditarWidget(DashboardWidgetModel widget)
    {
        WidgetEnEdicion = widget;
        MostrarEditor = true;
    }

    private void CerrarEditor()
    {
        MostrarEditor = false;
        WidgetEnEdicion = null;
    }

    private void GuardarWidgetEditado(DashboardWidgetModel updatedWidget)
    {
        // Como la referencia al widget original ya está actualizada, solo refrescamos
        MostrarEditor = false;
        WidgetEnEdicion = null;
        StateHasChanged();
    }
}
