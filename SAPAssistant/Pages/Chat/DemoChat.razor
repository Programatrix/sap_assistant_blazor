@page "/demo/chat"
@attribute [AllowAnonymous]
@layout PublicLayout
@using Microsoft.AspNetCore.Components.Web
@using SAPAssistant.Components.Chat
@using SAPAssistant.Models.Chat
@using SAPAssistant.Service
@using SAPAssistant.Models
@inject IJSRuntime JS
@inject AssistantService AssistantService

<div class="chat-content-full">
    <div class="messages" @ref="messagesContainer">
        @foreach (var msg in Messages)
        {
            <DynamicComponent Type="@GetComponentType(msg)" Parameters="GetParameters(msg)" />
        }
    </div>

    <div class="input-area">
        <SearchBar @bind-SearchText="UserInput" OnSearch="SendMessage" Disabled="isProcessing" />
        @if (isProcessing)
        {
            <div class="loading-spinner">âŒ› Procesando...</div>
        }
    </div>
</div>

@code {
    private string UserInput { get; set; } = string.Empty;
    private List<MessageBase> Messages { get; set; } = new();
    private ElementReference messagesContainer;
    private bool isProcessing = false;

    private async Task SendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message) || isProcessing) return;

        isProcessing = true;
        Messages.Add(new TextMessage
            {
                Content = message,
                IsUser = true
            });

        try
        {
            var resultado = await AssistantService.ConsultarAsync(message);

            if (resultado?.Tipo == "aclaracion" || resultado?.Tipo == "asistente")
            {
                Messages.Add(new TextMessage
                    {
                        IsUser = false,
                        Content = resultado.Mensaje
                    });
            }
            else if (resultado?.Tipo == "resumen")
            {
                Messages.Add(new TextMessage
                    {
                        IsUser = false,
                        Content = resultado.Resumen
                    });
            }
            else if (resultado?.Tipo == "system")
            {
                Messages.Add(new SystemMessage
                    {
                        Mensaje = resultado.Mensaje
                    });
            }
            else
            {
                Messages.Add(new ResultMessage
                    {
                        IsUser = false,
                        Resumen = resultado?.Resumen ?? string.Empty,
                        Sql = resultado?.Sql ?? string.Empty,
                        Resultados = resultado?.Resultados ?? new()
                    });
            }
        }
        catch (Exception ex)
        {
            Messages.Add(new ErrorMessage
                {
                    IsUser = false,
                    Error = ex.Message
                });
        }

        isProcessing = false;
        await ScrollToBottom();
    }

    private async Task ScrollToBottom()
    {
        await JS.InvokeVoidAsync("chatEnhancer.scrollToBottom", messagesContainer);
    }

    private Type GetComponentType(MessageBase msg)
    {
        return msg.Type switch
        {
            "Text" => typeof(TextMessageComponent),
            "Result" => typeof(ResultMessageComponent),
            "Error" => typeof(ErrorMessageComponent),
            "system" => typeof(SystemMessageComponent),
            _ => typeof(TextMessageComponent)
        };
    }

    private Dictionary<string, object> GetParameters(MessageBase msg)
    {
        return new()
        {
            ["Message"] = msg
        };
    }
}
