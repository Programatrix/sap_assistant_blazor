@using SAPAssistant.Components.Chart
@using SAPAssistant.Models.Chart
@using SAPAssistant.Models.Chat
@inject IJSRuntime JS
@inject IDialogService DialogService
@using MudBlazor
@layout TestLayaout

<div class="resultado-panel">
    <h3>🧠 Resumen generado</h3>
    <p>@((MarkupString)M.Resumen)</p>

    <div class="botones-acciones">
        <button class="toggle-sql-btn" @onclick="() => MostrarSql = !MostrarSql">
            @(MostrarSql ? "Ocultar consulta SQL" : "Ver consulta SQL")
        </button>
        <select class="view-select" @onchange="ChangeViewType" value="@M.ViewType">
            <option value="grid">Grid</option>
            <option value="cards">Cards</option>
            <option value="kpi">KPI</option>
            <option value="chart">Chart</option>
        </select>
    </div>

    @if (MostrarSql)
    {
        <div class="sql-block">
            <button class="copy-btn" @onclick="CopiarSql" title="Copiar">📋</button>
            <pre>@M.Sql</pre>
        </div>
    }

    @if (M.ViewType == "chart")
    {
        @if (Config == null)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenChartConfigurator">
                Configurar gráfico
            </MudButton>
        }
        else
        {
            <div class="d-flex gap-2 align-items-center mb-3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenChartConfigurator">
                    Reconfigurar gráfico
                </MudButton>
            </div>

            <InteractiveChartComponent Data="M.Data"
                                       Config="Config" />
        }
    }
</div>

@code {
    [Parameter] public MessageBase Message { get; set; }
    [Parameter] public EventCallback<string> OnViewTypeChange { get; set; }

    private ResultMessage M => (ResultMessage)Message;
    private bool MostrarSql { get; set; }
    private ChartConfig? Config;

    private async Task CopiarSql()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", M.Sql);
    }

    private async Task ChangeViewType(ChangeEventArgs e)
    {
        var newType = e.Value?.ToString() ?? "grid";

        // Si ya es chart, forzamos el refresco
        if (newType == "chart" && M.ViewType == "chart")
        {
            Config = null;
        }

        M.ViewType = newType;

        if (newType != "chart")
        {
            Config = null;
        }

        await OnViewTypeChange.InvokeAsync(newType);
    }

    private async Task OpenChartConfigurator()
    {
        var parameters = new DialogParameters
            {
                ["Data"] = M.Data,
                ["InitialConfig"] = Config
            };

        IDialogReference result = await DialogService.ShowAsync<ChartConfigurator>("Configurar gráfico", parameters);
        var response = await result.Result;

        if (response is not null && !response.Canceled && response.Data is ChartConfig config)
        {
            Config = config;
            StateHasChanged(); // Forzar renderizado para que pase el nuevo config al gráfico
        }
    }
}
