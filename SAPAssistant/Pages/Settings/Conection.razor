@page "/conexiones"
@layout PostLoginLayout
@using SAPAssistant.Service
@using SAPAssistant.Components.Connection
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject NavigationManager Navigation
@inject ConnectionService ConnectionService
@inject ProtectedSessionStorage SessionStorage

<div class="page-container">
    <div class="section-header">
        <h2 class="page-title">🔗 Selecciona una conexión activa</h2>
    </div>
    <p class="page-subtitle">Necesitas una conexión activa para usar el asistente.</p>

    <div class="section">
        <div class="table-wrapper">
            <ConectionManager OnConnectionActivated="HandleConnectionActivated" EsModal="false" />
        </div>
    </div>

    @if (MostrarAviso)
    {
        <div class="mensaje-error">
            ⚠️ La conexión previamente activa ya no es válida.
        </div>
    }

    @if (HayConexionActiva)
    {
        
        <div class="new-conn-container">
            <button class="new-conn-btn" @onclick="VolverHome">
                ✅ Volver al inicio
            </button>
        </div>
    }
</div>

@code {
    private bool HayConexionActiva = false;
    private bool MostrarAviso = false;

    private void NuevaConexion()
    {
        Navigation.NavigateTo("/conexiones/nueva");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await SessionStorage.GetAsync<string>("active_connection_id");
            if (result.Success && !string.IsNullOrEmpty(result.Value))
            {
                var isValid = await ConnectionService.ValidateConnectionAsync(result.Value);
                if (isValid)
                {
                    HayConexionActiva = true;
                }
                else
                {
                    HayConexionActiva = false;
                    MostrarAviso = true;
                    await SessionStorage.DeleteAsync("active_connection_id");
                }
                StateHasChanged();
            }
        }
    }

    private void HandleConnectionActivated(bool activo)
    {
        HayConexionActiva = activo;
        MostrarAviso = false;
        StateHasChanged();
    }

    private void VolverHome() => Navigation.NavigateTo("/");
}
